<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="advanced-search.html">
<link rel="import" href="business-listing.html">
<link rel="import" href="home-page.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="places-input.html">
<link rel="import" href="search-results.html">
<link rel="import" href="valid-form.html">

<dom-module id="restaurant-reviewer">

  <template>

    <style>
      :host {
        display: block;
          --app-primary-color: #5ca4ec;
          --app-light-primary-color: #BBDEFB;
          --app-secondary-color: black;
          --app-accent-color:  #FFE05C;
          --divider-color: #B6B6B6;
          --valid-form-button: {
              border-radius: 25%;
              background-color:  #FFE05C;
              flex: 0 1 auto;
              padding-left: 10px;
          }
          --valid-form-form: {
              background-color: var(--app-light-primary-color);
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              align-items: center;
              align-content:stretch;
              padding: 5px;
          }
      }

     :host([page=business]) .menu-btn {
         display: none;
     }

     :host(:not([page=business])) .back-btn {
         display: none;
     }

     :host([page=advanced]) #searchBar {
         display: none;
     }

     :host(:not([page=search])) .filterControls {
         display: none;
     }


      app-header {
        background-color: var(--app-primary-color);
        color: black;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        line-height: 40px;
        text-decoration: none;
        color: var(--app-secondary-color);
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

     .logo {
         text-align: center;
     }

     .logo a {
         font-size: 16px;
         font-weight: 600;
         letter-spacing: 0.3em;
         color: black;
         text-decoration: none;
         /* required for IE 11, so this <a> can receive pointer events */
         display: inline-block;
         pointer-events: auto;
     }


     .left-bar-item {
         width: 40px;
     }

     app-drawer {
         z-index: 3;
     }


     paper-slider {
         width: 30em;
         margin-left: 10em;
     }

     label {
         margin-left: 15em;
     }

     .flex {
         display: flex;
         justify-content: center;
         align-items: center;
     }

     .row {
         flex-direction: row;
     }

     .column {
         flex-direction: column;
     }

     .header__input--rounded {
         /* border-radius: 25%; */
         color: var(--app-secondary-color);
         flex: 1 1 auto;
         padding-left: 10px;
         padding-right: 10px;
     }

     iron-pages {
         max-width: 960px;
         margin: 0 auto;
     }

     #tabContainer {
         background-color: var(--app-light-primary-color);
         display: flex;
         flex-direction: column;
     }

     .advancedSearch {
         align-self: flex-end;
     }

     .advancedSearch a {
         text-decoration: none;
     }

     /* paper-icon-button has no hidden attribute  */
     @media screen and (min-width: 768px) {
         .menu-btn {
             display: none;
         }
     }

     .logo a:focus {
         outline: 1px solid black;
     }

    </style>

    <google-maps-api version="3.exp" api-key="AIzaSyBkHxZZzchmvczNvUWMznd0DicwOWZ9dSE" library-loaded="{{googleLoaded}}"></google-maps-api>

    <app-location route="{{route}}" query-params="{{queryParams}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}"></app-route>
    <app-route route="{{route}}" pattern="/search" active="{{searchActive}}" tail="{{searchTail}}"></app-route>
    <app-route route="{{route}}" pattern="/business"></app-route>

    <iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>

    <app-header role="navigation" id="header" effects="waterfall" condenses reveals>
      <app-toolbar>
        <div class="left-bar-item">
          <paper-icon-button
              class="menu-btn"
              icon="menu"
              on-tap="_toggleDrawer"
              aria-label="App Menu">
          </paper-icon-button>
          <a id="backBtn" class="back-btn" tabindex="-1">
            <paper-icon-button icon="arrow-back" aria-label="Go back"></paper-icon-button>
          </a>
        </div>
        <div class="logo" title><a href="/#/home" aria-label="Reviewer Home">Restaurant Reviewer</a></div>
      </app-toolbar>
    </app-header>

    <!-- Restaurant Search Bar -->
    <div id="tabContainer">
      <div id="searchBar" class="header__search">
        <valid-form id="searchForm" button="Search">
          <iron-a11y-keys id="a11y" target="[[termTarget]]" keys="enter"
                          on-keys-pressed="_submitSearch"></iron-a11y-keys>
          <paper-input aria-label="Business Name or Category"
                       id="searchLocation"
                       placeholder="Joe's diner, tacos, steakhouses"
                       class="header__input--rounded"
                       value="{{queryParams.search}}"
                       required>
            <iron-icon icon="search" prefix></iron-icon>
            <div suffix></div>
          </paper-input>
          <iron-a11y-keys id="a11y" target="[[locationTarget]]" keys="enter"
                          on-keys-pressed="_submitSearch"></iron-a11y-keys>
          <places-input class="header__input--rounded"
                        value="{{location}}"
                        lat="{{latitude}}"
                        lng="{{longitude}}"
                        aria-label="location"
                        placeholder="address, neighborhood, city, state"
                        required>
            <iron-icon icon="communication:location-on" prefix></iron-icon>
            <div suffix></div>
          </places-input>
        </valid-form>
        <div  class="filterControls flex column">
          <h4>Search Filters: </h4>
          <div class="flex row">
            <paper-toggle-button id="openFilter" on-tap="toggleOpen">Open Now</paper-toggle-button>
            <div>
              <label for="minPriceFilter">Minimum Price</label>
              <paper-slider id="minPriceFilter"
                            aria-label="Minimum Price"
                            value="{{lowPrice}}"
                            min="1"
                            max="5"
                            required
                            editable></paper-slider>
            </div>
            <div>
              <label for="maxPriceFilter">Maximum Price</label>
              <paper-slider id="maxPriceFilter"
                            aria-label="Maximum Price"
                            value="{{highPrice}}"
                            min="1"
                            max="5"
                            required
                            editable></paper-slider>
            </div>
          </div>
        </div>
      </div>
      <div class="advancedSearch">
        <a href="#" on-tap="_toAdvSearch">advanced search</a>
      </div>
    </div>

    <!-- Drawer content for small screens -->
    <template is="dom-if" if="[[smallScreen]]">
      <app-drawer opened="{{drawerOpened}}" swipe-open tabindex="0">
        <iron-selector selected="{{page}}" attr-for-selected="name" class="drawer-list" role="navigation">
          <a name="home" href="/#/home">Home</a>
          <a name="search" href="#" on-tap="_toSearch">Search Results</a>
        </iron-selector>
      </app-drawer>
    </template>

    <!-- page is used here instead of routeData.page for CSS styling -->
    <iron-pages role="main" selected="{{page}}" attr-for-selected="name">
      <home-page name="home"
                 search-term="{{queryParams.search}}"
                 submit="{{submitSearch}}"
                 business="{{business}}"
                 query-params="{{queryParams}}"
                 coords="[[coords]]"></home-page>
      <advanced-search name="advanced"
                       route="{{route}}"
                       query-params="{{queryParams}}"
                       location="{{location}}"
                       latitude="{{latitude}}"
                       longitude="{{longitude}}"
                       open-now="{{openNow}}"
                       min-price="{{minPrice}}"
                       max-price="{{maxPrice}}"
                       radius="{{radius}}"></advanced-search>
      <search-results name="search"
                      route="{{searchTail}}"
                      active="{{searchActive}}"
                      map="[[listingMap]]"
                      search-results="[[searchResults]]"
                      coords="[[coords]]"
                      query-params="{{queryParams}}"
                      min-price="[[minPrice]]"
                      max-price="[[maxPrice]]"
                      open-filter="[[openFilter]]"
                      min-filter="[[lowPrice]]"
                      max-filter="[[highPrice]]"
                      radius="[[radius]]"
                      business="{{business}}"></search-results>
      <business-listing name="business"
                        listing-map="[[listingMap]]"
                        coords="[[coords]]"
                        reviews="{{reviews}}"
                        business="[[formattedBusiness]]"></business-listing>
    </iron-pages>

    <!-- fake google map element for the Google Places library -->
    <div id="map"></div>

  </template>

  <script>

   Polymer({

     is: 'restaurant-reviewer',

     properties: {
       page: {
         type: String,
         reflectToAttribute: true
       },

       routeData: {
         type: Object,
         notify: true,
         value: function() {
           return {
             page: "home"
           }
         }
       },

       route: {
         type: Object
       },

       searchTail: {
         type: Object,
         notify: true
       },

       searchActive: {
         type: Boolean,
         notify: true
       },

       queryParams: {
         type: Object,
         notify: true
       },

       smallScreen: {
         type: Boolean,
         observer: "_searchStyle"
       },

       latitude: {
         type: Number,
         notify: true
       },

       longitude: {
         type: Number,
         notify: true
       },

       coords: {
         computed: '_getCoords(latitude, longitude)'
       },

       searchResults: {
         type: Array,
         value: function() {
           return [];
         }
       },

       submitSearch: {
         type: Boolean,
         value: false,
         observer: "_submitSearch"
       },

       business: {
         type: Object,
         notify: true,
         observer: "_showBusiness"
       },

       formattedBusiness: {
         type: Object,
         notify: true
       },

       reviews: {
         type: Array,
         notify: true,
         value: function() {
           return [];
         }
       },

       listingMap: {
         type: Object,
         notify: true,
         value: function() {
           return this.$.map;
         }
       },

       termTarget: {
         type: Object,
         notify: true,
         value: function() {
           return this.$.searchTerm;
         }
       },

       locationTarget: {
         type: Object,
         notify: true,
         value: function() {
           return this.$.searchLocation;
         }
       },

       location: {
         type: String,
         notify: true
       },

       openNow: {
         type: Boolean,
         notify: true
       },

       minPrice: {
         type: Number,
         notify: true,
         value: 0
       },

       maxPrice: {
         type: Number,
         notify: true,
         value: 4
       },

       radius: {
         type: Number,
         notify: true,
         value: 10000
       },

       googleLoaded: {
         type: Boolean,
         value: false
       },

       openFilter: {
         type: Boolean,
         value: false
       },

       lowPrice: {
         type: Number,
         value: 1
       },

       highPrice: {
         type: Number,
         value: 5
       }

     },

     listeners: {
       'searchForm.iron-form-submit': '_textSearch',
       'backBtn.tap': '_goBack'
     },

     observers: [
       '_routePageChanged(routeData.page)',
       '_detectLocation(googleLoaded)',
       'setMin(highPrice)',
       'setMax(lowPrice)'
     ],

     // paper-toggle-button isn't binding with value :/
     toggleOpen: function(e, d, m) {
       this.openFilter = this.$.openFilter.checked;
     },

     // mostly for styling the CSS back and menu buttons
     _routePageChanged: function(page) {
       // redirect to home-page on startup (helps with business-listing navigation)
       if (this.route === undefined)
         document.location = "/#/home";

       this.page = page || "home";
        // Scroll to the top of the page on every *route* change. Use `Polymer.AppLayout.scroll`
        // with `behavior: 'silent'` to disable header scroll effects during the scroll.
        Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
        // Close the drawer - in case the *route* change came from a link in the drawer.
        this.drawerOpened = false;
     },

     _toggleDrawer: function() {
       this.drawerOpened = !this.drawerOpened;
     },

     /**
      * Adapts the search bar to column or row layout based on screen size
      *
      * @param {Boolean} smallScreen
      */
     _searchStyle: function(smallScreen) {
       // clear any existing column or row classes
       this.$.searchBar.classList.remove("column");
       this.$.searchBar.classList.remove("row");

       // add the necessary column or row class based on screen size
       smallScreen?
       this.$.searchBar.classList.add("column") :
       this.$.searchBar.classList.add("row");
     },

     _goBack: function() {
       history.back();
     },

     // avoid removing the query params from the url
     _toSearch: function() {
       this.set('route.path', '/search');
     },

     _toAdvSearch: function() {
       this.set('route.path', '/advanced');
     },

     _detectLocation: function(loaded) {
       // wait for the library to load before doing geolocation
       if (loaded != true) return;

       var _this = this;

       if (!"geolocation" in navigator) return;

       var opts = {
         enableHighAccuracy: true,
         maximumAge: 5000
       };

       navigator.geolocation.getCurrentPosition(function (position) {
         var lat = position.coords.latitude,
             lng = position.coords.longitude;

         _this.latitude = lat;
         _this.longitude = lng;

         // set the location to the current address
         fetch("https://maps.googleapis.com/maps/api/geocode/json?latlng=" + lat + "," + lng).then(function (resp) {
           resp.json().then(function (places) {
             if (places.status == google.maps.places.PlacesServiceStatus.OK) {
               _this.location = places.results[0].formatted_address;
             } else {
               console.log("geolocation failed: ", places.status, places.error_message);
             }
           });
         });
       }, function (e) {
         console.log("geolocation error: ", e);
      }, opts);
     },

     _getCoords: function(lat, lng) {
       this.set('queryParams.lat', lat);
       this.set('queryParams.lng', lng);
       return new google.maps.LatLng(lat, lng);
     },

     setMax: function(low) {
       if (this.highPrice < low)
         this.highPrice = low;
     },

     setMin: function(high) {
       if (high < this.lowPrice)
         this.lowPrice = high;
     },

     /**
      * Resets advanced search params to their default values when the
      * app-header search is used and jumps to the page of search results.
      */
     _textSearch: function() {
       this.openNow = false,
       this.minPrice = 0,
       this.maxPrice = 4,
       this.radius = 10000;

       this.set('route.path', '/search');
     },

     _submitSearch: function(doSearch) {
       if (doSearch) {
         this.$.searchForm.submit();
         this.submitSearch = false;
       }
     },

     _fetchImageUrl: function(imageData) {
       imageUrl = imageData.getUrl({maxWidth: 1000, maxHeight: 500});
       return imageUrl;
     },

     loadReviews: function(business) {
       var _this2 = this;

       // load the custom reviews for this business
       var placeId = business.place_id;

       localforage.getItem(placeId, function (err, cachedReviews) {
         var reviews = business.reviews;

         if (cachedReviews == null) {
           _this2.reviews = reviews;
         } else {

         if (reviews == null) reviews = [];

           cachedReviews.map(function (review) {
             reviews.unshift(review);
           });

           _this2.reviews = reviews;
         }
       });
     },

      parseBusiness: function(business) {
        // find day of the week and use to get the current day's opening hours
        // weeks start on monday so monday = 0 and sunday = 6.
        // inspired by http://stackoverflow.com/questions/4156434/javascript-get-the-first-day-of-the-week-from-current-date
        var day = new Date().getDay();
        day = day - (day == 0 ? -6:1);

        // check that weekday_text exists, otherwise use the default
        var hours = "opening times not listed";
        if ("weekday_text" in business.opening_hours)
          hours = business.opening_hours.weekday_text[day];

        var address = business.formatted_address,
            imageData = business.photos || "https://maps.gstatic.com/tactile/pane/result-no-thumbnail-2x.png",
            hours = hours,
            phone = business.formatted_phone_number,
            placeId = business.place_id,
            price = business.price_level,
            rating = business.rating,
            title = business.name,
            website = business.website;

        var imageUrl = typeof(imageData) == "string" ? imageData : this._fetchImageUrl(imageData[0]);

        // separated because the review rendering must happen asynchronously
        this.loadReviews(business);

            return {
              address: address,
              hours: hours,
              image: imageUrl,
              phone: phone,
              placeId: placeId,
              price: price,
              rating: rating,
              title: title,
              website: website
            };
      },

     _showBusiness: function(business) {
       var _this3 = this;

       // center and zoom the business listing map
       // TODO: fix map here and add marker
       var map = new google.maps.Map(this.$.map, {
       });

       var request = {
         placeId: business.placeId || business.place_id
       };

       var places = new google.maps.places.PlacesService(map);
       places.getDetails(request, function (place, status) {
         if (status == google.maps.places.PlacesServiceStatus.OK) {
           // load the detailed business info for the listing page
           _this3.formattedBusiness = _this3.parseBusiness(place);

           // change to the business listing page when the selected business changes
           _this3.routeData.page = 'business';
         }
       });
     }

   });
  </script>

  <script type="text/javascript" src="../bower_components/localforage/dist/localforage.min.js"></script>

</dom-module>
